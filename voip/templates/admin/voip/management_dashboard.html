{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    <style>
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: box-shadow 0.3s ease;
        }
        
        .action-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .action-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .action-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .action-description {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .btn-action {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            font-size: 13px;
        }
        
        .btn-action:hover {
            background: #0056b3;
            color: white;
            text-decoration: none;
        }
        
        .quick-actions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .quick-btn {
            margin-right: 10px;
            margin-bottom: 5px;
        }
    </style>
{% endblock %}

{% block content %}
<h1>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VoIP —Å–∏—Å—Ç–µ–º–æ–π</h1>

<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-value">{{ statistics.active_servers }}/{{ statistics.total_servers }}</div>
        <div class="stat-label">SIP –°–µ—Ä–≤–µ—Ä—ã</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ statistics.active_numbers }}/{{ statistics.total_numbers }}</div>
        <div class="stat-label">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ statistics.active_accounts }}/{{ statistics.total_accounts }}</div>
        <div class="stat-label">SIP –ê–∫–∫–∞—É–Ω—Ç—ã</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ statistics.active_groups }}/{{ statistics.total_groups }}</div>
        <div class="stat-label">–ì—Ä—É–ø–ø—ã –Ω–æ–º–µ—Ä–æ–≤</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ statistics.active_rules }}/{{ statistics.total_rules }}</div>
        <div class="stat-label">–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ statistics.today_calls }}</div>
        <div class="stat-label">–ó–≤–æ–Ω–∫–∏ —Å–µ–≥–æ–¥–Ω—è</div>
    </div>
</div>

<div class="quick-actions">
    <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
    <button type="button" class="btn btn-primary quick-btn" onclick="quickAction('sync_accounts')">
        üë• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã
    </button>
    <button type="button" class="btn btn-secondary quick-btn" onclick="testRouting()">
        üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é
    </button>
    <button type="button" class="btn btn-info quick-btn" onclick="quickAction('check_health')">
        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã
    </button>
    <a href="{% url 'voip:voip-dashboard' %}" class="btn btn-success quick-btn" target="_blank">
        üìä –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥
    </a>
    <button type="button" class="btn btn-warning quick-btn" onclick="toggleMonitor()">
        üì± –ú–æ–Ω–∏—Ç–æ—Ä –æ—á–µ—Ä–µ–¥–µ–π
    </button>
</div>

<div class="action-buttons">
    <div class="action-card">
        <div class="action-icon">üè¢</div>
        <div class="action-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ SIP —Å–µ—Ä–≤–µ—Ä–∞</div>
        <div class="action-description">
            –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SIP —Å–µ—Ä–≤–µ—Ä—É –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        </div>
        <a href="{% url 'admin:voip-setup-server' %}" class="btn-action">
            –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
        </a>
    </div>
    
    <div class="action-card">
        <div class="action-icon">üë•</div>
        <div class="action-title">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–æ–º–µ—Ä–æ–≤</div>
        <div class="action-description">
            –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤ –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
        </div>
        <a href="{% url 'admin:voip-create-group' %}" class="btn-action">
            –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
        </a>
    </div>
    
    <div class="action-card">
        <div class="action-icon">üîÄ</div>
        <div class="action-title">–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏</div>
        <div class="action-description">
            –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
        </div>
        <a href="{% url 'admin:voip-create-rule' %}" class="btn-action">
            –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ
        </a>
    </div>
    
    <div class="action-card">
        <div class="action-icon">üìä</div>
        <div class="action-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</div>
        <div class="action-description">
            –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–≤–æ–Ω–∫–æ–≤ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥—Ä—É–ø–ø
        </div>
        <a href="{% url 'admin:voip-statistics' %}" class="btn-action">
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        </a>
    </div>
    
    <div class="action-card">
        <div class="action-icon">‚öôÔ∏è</div>
        <div class="action-title">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞</div>
        <div class="action-description">
            –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –º–æ–¥–µ–ª—è–º VoIP –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        </div>
        <a href="/admin/voip/" class="btn-action">
            –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É
        </a>
    </div>
    
    <div class="action-card">
        <div class="action-icon">üìñ</div>
        <div class="action-title">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API</div>
        <div class="action-description">
            –ò–∑—É—á–∏—Ç–µ API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
        </div>
        <a href="/voip/api/" class="btn-action" target="_blank">
            API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
        </a>
    </div>
</div>

<!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—á–µ—Ä–µ–¥–µ–π -->
<div id="liveMonitorContainer" style="display: none;">
    {% include "admin/voip/live_monitor_widget.html" %}
</div>

<script>
function quickAction(action) {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
    btn.disabled = true;
    
    fetch('{% url "admin:voip-quick-actions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: 'action=' + action
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
    })
    .finally(() => {
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

function testRouting() {
    const callerID = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–≤–æ–Ω—è—â–µ–≥–æ:', '+79001234567');
    if (!callerID) return;
    
    const calledNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –≤—ã–∑—ã–≤–∞–µ–º—ã–π –Ω–æ–º–µ—Ä:', '100');
    if (!calledNumber) return;
    
    const btn = event.target;
    btn.textContent = '–¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è...';
    btn.disabled = true;
    
    fetch('{% url "admin:voip-quick-actions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: 'action=test_routing&caller_id=' + callerID + '&called_number=' + calledNumber
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.routing_result;
            let message = `üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n\n`;
            message += `–î–µ–π—Å—Ç–≤–∏–µ: ${result.action}\n`;
            if (result.target) message += `–¶–µ–ª—å: ${result.target}\n`;
            if (result.target_type) message += `–¢–∏–ø: ${result.target_type}\n`;
            if (result.group) message += `–ì—Ä—É–ø–ø–∞: ${result.group}\n`;
            if (result.message) message += `–°–æ–æ–±—â–µ–Ω–∏–µ: ${result.message}\n`;
            
            alert(message);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error);
    })
    .finally(() => {
        btn.textContent = 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é';
        btn.disabled = false;
    });
}

function toggleMonitor() {
    const container = document.getElementById('liveMonitorContainer');
    const btn = event.target;
    
    if (container.style.display === 'none') {
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä
        container.style.display = 'block';
        btn.textContent = 'üì± –°–∫—Ä—ã—Ç—å –º–æ–Ω–∏—Ç–æ—Ä –æ—á–µ—Ä–µ–¥–µ–π';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-info');
        
        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        container.style.opacity = '0';
        container.style.transform = 'translateY(-20px)';
        container.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
            container.style.opacity = '1';
            container.style.transform = 'translateY(0)';
        }, 10);
    } else {
        // –°–∫—Ä—ã—Ç—å –º–æ–Ω–∏—Ç–æ—Ä
        container.style.opacity = '0';
        container.style.transform = 'translateY(-20px)';
        
        setTimeout(() => {
            container.style.display = 'none';
            btn.textContent = 'üì± –ú–æ–Ω–∏—Ç–æ—Ä –æ—á–µ—Ä–µ–¥–µ–π';
            btn.classList.remove('btn-info');
            btn.classList.add('btn-warning');
        }, 300);
    }
}
</script>

<!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ -->
{% csrf_token %}
{% endblock %}