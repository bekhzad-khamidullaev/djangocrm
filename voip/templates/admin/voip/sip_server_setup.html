{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    <style>
        .form-container {
            max-width: 800px;
            margin: 20px 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        
        .form-row {
            margin-bottom: 15px;
        }
        
        .form-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-row input, .form-row textarea {
            width: 100%;
            max-width: 400px;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .form-row .help-text {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-row input[type="checkbox"] {
            width: auto;
        }
        
        .existing-servers {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .server-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .server-info {
            flex: 1;
        }
        
        .server-name {
            font-weight: bold;
            color: #495057;
        }
        
        .server-details {
            font-size: 12px;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .server-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .submit-row {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            margin-right: 10px;
        }
        
        .btn-back:hover {
            background: #545b62;
            color: white;
            text-decoration: none;
        }
        
        .example-configs {
            background: #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .example-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .example-item {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .example-item strong {
            color: #007bff;
        }
    </style>
{% endblock %}

{% block content %}
<h1>üè¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SIP —Å–µ—Ä–≤–µ—Ä–∞</h1>

<p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∞—à–µ–º—É SIP —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤–æ–Ω–∫–æ–≤.</p>

<div class="form-container">
    <form method="post">
        {% csrf_token %}
        
        <div class="form-row">
            <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
            {{ form.name }}
            {% if form.name.help_text %}
                <div class="help-text">{{ form.name.help_text }}</div>
            {% endif %}
            {% if form.name.errors %}
                <div class="error">{{ form.name.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label for="{{ form.host.id_for_label }}">{{ form.host.label }}</label>
            {{ form.host }}
            {% if form.host.help_text %}
                <div class="help-text">{{ form.host.help_text }}</div>
            {% endif %}
            {% if form.host.errors %}
                <div class="error">{{ form.host.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label for="{{ form.websocket_uri.id_for_label }}">{{ form.websocket_uri.label }}</label>
            {{ form.websocket_uri }}
            {% if form.websocket_uri.help_text %}
                <div class="help-text">{{ form.websocket_uri.help_text }}</div>
            {% endif %}
            {% if form.websocket_uri.errors %}
                <div class="error">{{ form.websocket_uri.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-row">
            <label for="{{ form.realm.id_for_label }}">{{ form.realm.label }}</label>
            {{ form.realm }}
            {% if form.realm.help_text %}
                <div class="help-text">{{ form.realm.help_text }}</div>
            {% endif %}
            {% if form.realm.errors %}
                <div class="error">{{ form.realm.errors }}</div>
            {% endif %}
        </div>
        
        <div class="checkbox-row">
            {{ form.create_accounts }}
            <label for="{{ form.create_accounts.id_for_label }}">{{ form.create_accounts.label }}</label>
        </div>
        {% if form.create_accounts.help_text %}
            <div class="help-text" style="margin-left: 24px;">{{ form.create_accounts.help_text }}</div>
        {% endif %}
        
        <div class="submit-row">
            <a href="{% url 'admin:voip-management' %}" class="btn-back">‚Üê –ù–∞–∑–∞–¥</a>
            <input type="submit" value="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä" class="default">
        </div>
    </form>
</div>

<div class="example-configs">
    <div class="example-title">üìã –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:</div>
    
    <div class="example-item">
        <strong>Asterisk:</strong> 
        Host: asterisk.example.com, WebSocket: wss://asterisk.example.com:8089/ws
    </div>
    
    <div class="example-item">
        <strong>FreeSWITCH:</strong> 
        Host: freeswitch.example.com, WebSocket: wss://freeswitch.example.com:7443
    </div>
    
    <div class="example-item">
        <strong>3CX:</strong> 
        Host: your-3cx.com, WebSocket: wss://your-3cx.com:5091
    </div>
    
    <div class="example-item">
        <strong>–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:</strong> 
        Host: 192.168.1.100, WebSocket: ws://192.168.1.100:8088/ws
    </div>
</div>

{% if existing_servers %}
<div class="existing-servers">
    <h3>üì° –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–µ—Ä—ã</h3>
    
    {% for server in existing_servers %}
    <div class="server-item">
        <div class="server-info">
            <div class="server-name">{{ server.name }}</div>
            <div class="server-details">
                {{ server.host }} | {{ server.websocket_uri }}
                {% if server.internal_numbers.count %}
                    | {{ server.internal_numbers.count }} –Ω–æ–º–µ—Ä–æ–≤
                {% endif %}
            </div>
        </div>
        
        <div class="server-status {% if server.active %}status-active{% else %}status-inactive{% endif %}">
            {% if server.active %}–ê–∫—Ç–∏–≤–Ω—ã–π{% else %}–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π{% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ realm –Ω–∞ –æ—Å–Ω–æ–≤–µ host
document.getElementById('id_host').addEventListener('input', function(e) {
    const host = e.target.value;
    const realmField = document.getElementById('id_realm');
    
    if (!realmField.value && host) {
        realmField.value = host;
    }
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è WebSocket URI
document.getElementById('id_websocket_uri').addEventListener('blur', function(e) {
    const uri = e.target.value;
    if (uri && !uri.match(/^wss?:\/\//)) {
        alert('‚ö†Ô∏è WebSocket URI –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å ws:// –∏–ª–∏ wss://');
        e.target.focus();
    }
});
</script>
{% endblock %}