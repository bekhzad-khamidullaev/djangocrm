{% extends "admin/base_site.html" %}{% load static i18n %}
{% block content %}
<h1>{% translate 'SIPml Client' %}</h1>
<p class="help">{% translate 'Use your SIP account to register and place a call.' %}</p>
<div id="sipml-ui" style="max-width:720px">
  <fieldset>
    <legend>{% translate 'Account' %}</legend>
    <label>{% translate 'Realm (domain)' %}: <input id="sip-realm" type="text" value="{{ sip_prefill.realm|default:'' }}" /></label>
    <label>{% translate 'Identity (IMPI/username)' %}: <input id="sip-impi" type="text" value="{{ sip_prefill.impi|default:'' }}" /></label>
    <label>{% translate 'Display name' %}: <input id="sip-display" type="text" value="{{ sip_prefill.display|default:user_display_name }}" /></label>
    <label>{% translate 'Password' %}: <input id="sip-password" type="password" value="{{ sip_prefill.password|default:'' }}" /></label>
    <button id="btn-register" class="button button-primary">{% translate 'Register' %}</button>
    <button id="btn-unregister" class="button">{% translate 'Unregister' %}</button>
    <span id="reg-status" style="margin-left:8px"></span>
  </fieldset>
  <fieldset>
    <legend>{% translate 'Dialer' %}</legend>
    <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
      <div>
        <label>{% translate 'Number or SIP URI' %}: <input id="dial-number" type="text" placeholder="e.g. 1001 or sip:1001@domain" style="width:220px" /></label>
        <div style="margin-top:6px">
          <button id="btn-call" class="button button-primary">{% translate 'Call' %}</button>
          <button id="btn-hangup" class="button">{% translate 'Hang up' %}</button>
          <span id="call-status" style="margin-left:8px"></span>
        </div>
      </div>
      <div>
        <style>
          .dialpad { display:grid; grid-template-columns:repeat(3,56px); gap:8px; }
          .dialpad button { padding:12px 0; font-size:16px; }
        </style>
        <div class="dialpad">
          <button type="button" data-d="1">1</button>
          <button type="button" data-d="2">2</button>
          <button type="button" data-d="3">3</button>
          <button type="button" data-d="4">4</button>
          <button type="button" data-d="5">5</button>
          <button type="button" data-d="6">6</button>
          <button type="button" data-d="7">7</button>
          <button type="button" data-d="8">8</button>
          <button type="button" data-d="9">9</button>
          <button type="button" data-d="*">*</button>
          <button type="button" data-d="0">0</button>
          <button type="button" data-d="#">#</button>
          <button type="button" id="dial-back">⌫</button>
          <button type="button" id="dial-clear" style="grid-column: span 2">{% translate 'Clear' %}</button>
        </div>
      </div>
    </div>
  </fieldset>
  <fieldset>
    <legend>{% translate 'Logs' %}</legend>
    <pre id="logs" style="max-height:240px; overflow:auto; background:#111; color:#ddd; padding:8px"></pre>
  </fieldset>
</div>
<script src="{% static 'voip/sipml/SIPml-api.js' %}"></script>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (m)=>{ const el=$('logs'); el.textContent += (m+'\n'); el.scrollTop = el.scrollHeight; };
  let stack = null, callSession = null, registerSession = null;
  function status(el, msg){ el.textContent = msg; }
  function createStack(){
    const realm = $('sip-realm').value.trim();
    const impi = $('sip-impi').value.trim();
    const display = $('sip-display').value.trim();
    const password = $('sip-password').value;
    if (!realm || !impi){ alert('Enter realm and identity'); return null; }
    const impu = 'sip:'+impi+'@'+realm;
    stack = new SIPml.Stack({
      realm, impi, impu, password,
      display_name: display,
      enable_rtcweb_breaker: true,
      events_listener: { events: '*', listener: onSipEventStack },
      bandwidth: null,
      video_size: null
    });
    return stack;
  }
  function onSipEventStack(e){
    log('STACK: '+e.type+(e.description?(' - '+e.description):''));
    switch(e.type){
      case 'started':
        doRegister();
        break;
      case 'stopped':
        status($('reg-status'), 'stopped');
        break;
      case 'i_new_call':
        if(callSession){ e.newSession.hangup(); return; }
        callSession = e.newSession;
        attachCallEvents(callSession);
        status($('call-status'),'Incoming call');
        break;
    }
  }
  function attachCallEvents(sess){
    sess.setConfiguration({
      audio_remote: document.createElement('audio'),
      events_listener: { events: '*', listener: onSipEventSession }
    });
  }
  function onSipEventSession(e){
    log('CALL: '+e.type);
    switch(e.type){
      case 'connected': status($('call-status'),'Connected'); break;
      case 'terminating': case 'terminated': status($('call-status'),'Terminated'); callSession=null; break;
      case 'i_ao_request': /* ringback */ break;
    }
  }
  function doRegister(){
    if(!stack) return;
    registerSession = stack.newSession('register', { expires: 200 });
    registerSession.register();
    status($('reg-status'),'Registering…');
  }
  function doUnregister(){ try{ registerSession && registerSession.unregister(); }catch(e){} }
  function doCall(){
    if(!stack){ if(!createStack()) return; stack.start(); return; }
    const to = $('dial-number').value.trim();
    if(!to){ alert('Enter number'); return; }
    const realm = $('sip-realm').value.trim();
    const target = to.startsWith('sip:') ? to : ('sip:'+to+'@'+realm);
    callSession = stack.newSession('call-audio', { events_listener:{ events:'*', listener:onSipEventSession }});
    callSession.call(target);
    status($('call-status'),'Calling…');
  }
  function doHangup(){ try{ callSession && callSession.hangup(); }catch(e){} }
  $('btn-register').addEventListener('click', function(){
    if(!createStack()) return; stack.start();
  });
  $('btn-unregister').addEventListener('click', doUnregister);
  $('btn-call').addEventListener('click', doCall);
  $('btn-hangup').addEventListener('click', doHangup);
  document.querySelectorAll('.dialpad [data-d]')?.forEach(btn=>{
    btn.addEventListener('click', function(){
      const inp = $('dial-number');
      inp.value = (inp.value || '') + this.getAttribute('data-d');
      inp.focus();
    })
  });
  $('dial-back')?.addEventListener('click', function(){
    const inp = $('dial-number');
    inp.value = (inp.value||'').slice(0, -1);
    inp.focus();
  });
  $('dial-clear')?.addEventListener('click', function(){
    const inp = $('dial-number');
    inp.value = '';
    inp.focus();
  });
})();
</script>
{% endblock %}
